## Работа с загрузчиком

### Задание

1. Попасть в систему без пароля несколькими способами.
2. Установить систему с LVM, после чего переименовать VG.
3. Добавить модуль в initrd.

### Попасть в систему без пароля несколькими способами

- Открыть **GUI VirtualBox** (или другой системы виртуализации), запустить виртуальную машину и при выборе ядра для загрузки нажать **e** - в данном контексте edit. В открывшемся окне изменить параметры загрузки.

![screenshot1](https://github.com/ellopa/otus-grub/blob/main/screenshot1.png)

### Способ 1. init=/bin/sh

- В конце строки начинающейся с **linux16** добавить **init=/bin/sh** и нажать **сtrl-x** для загрузки в систему.
- Рутовая файловая система при этом монтируется в режиме **Read-Only**.Для перемонтировать ее в режим **Read-Write** можно воспользоваться командой:
```bash
mount -o remount,rw /
```
- После чего можно убедиться, записав данные в любой файл или прочитав вывод команды:
```bash
mount | grep root
```

### Способ 2. rd.break

- В конце строки начинающейся с **linux16** добавить **rd.break** и нажать **сtrl-x** для загрузки в систему.
- Попадаем в emergency mode. Наша корневая файловая система смонтирована, но опять режим **Read-Only** и мы не в ней. Чтобы попасть в нее и поменять пароль администратора нужно выполнить:
```bash
mount -o remount,rw /sysroot
chroot /sysroot
passwd root
touch /.autorelabel
```

- После чего можно перезагрузить и зайти в систему с новым паролем.

>- Полезно когда потеряy или вообще нет пароля администратора.

### Способ 3. rw init=/sysroot/bin/sh

- Нажимаем английскую клавишу «e» для входя в редактирование. В открывшемся окне выбираем (клавишами клавиши «↓» и «↑») строку, начинающуюся с «linux16». Меняем значение **ro** на **rw**, а после через пробел дописываем отрывок **init=/sysroot/bin/sh**. В итоге должно получиться **rw init=/sysroot/bin/sh**. После этого нажимаем сочетание клавиш **Ctrl+X**.

![screenshot2](https://github.com/ellopa/otus-grub/blob/main/screenshot2.png)

- Набрать команду «chroot /sysroot», далее  команда для  смены пароля **passwd**.

![screenshot3](https://github.com/ellopa/otus-grub/blob/main/screenshot3.png)

- Ввести новый пароль и подтвердить его.

>- В целом то же самое что и в прошлом примере, но файловая система сразу смонтирована в режим Read-Write
>- В прошлых примерах тоже можно заменить **ro** на **rw** 
>- Набор происходит в «слепом» режиме (знаки не отображаются совсем).

- Чтобы изменение пароля root  на centOS 7 вступило в силу, нужно обновить параметры SELinux. Вводим команду **touch /.autorelabel»** и перезагрузить сервер.

### Установить систему с LVM и переименовать VG.

- Первым делом посмотрим текущее состояние системы:
```
[vagrant@lvm ~]$ sudo -i
[root@lvm ~]# vgs
  VG         #PV #LV #SN Attr   VSize   VFree
  VolGroup00   1   2   0 wz--n- <38.97g    0 
```
- Переименовать.
```
[root@lvm ~]# vgrename VolGroup00 OtusRoot
  Volume group "VolGroup00" successfully renamed to "OtusRoot"
```
- Исправить **/etc/fstab**,**/etc/default/grub**,**/boot/grub2/grub.cfg** везде заменяем старое название VG на новое.
 Примеры файлов:
 [/etc/fstab](https://gist.github.com/lalbrekht/cdf6d745d048009dbe619d9920901bf9),
 [/etc/default/grub](https://gist.github.com/lalbrekht/ef78c39c236ae223acfb3b5e1970001c), 
 [/boot/grub2/grub.cfg](https://gist.github.com/lalbrekht/1a9cae3cb64ce2dc7bd301e48090bd56).
 
```
#
# /etc/fstab
# Created by anaconda on Sat May 12 18:50:26 2018
#
# Accessible filesystems, by reference, are maintained under '/dev/disk'
# See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) for more info
#
/dev/mapper/OtusRoot-LogVol00 /                       xfs     defaults        0 0
UUID=570897ca-e759-4c81-90cf-389da6eee4cc /boot                   xfs     defaults        0 0
/dev/mapper/OtusRoot-LogVol01 swap                    swap    defaults        0 0
#VAGRANT-BEGIN
# The contents below are automatically generated by Vagrant. Do not modify.
#VAGRANT-END
```
```
GRUB_TIMEOUT=1
GRUB_DISTRIBUTOR="$(sed 's, release .*$,,g' /etc/system-release)"
GRUB_DEFAULT=saved
GRUB_DISABLE_SUBMENU=true
GRUB_TERMINAL_OUTPUT="console"
$e=0 elevator=noop crashkernel=auto rd.lvm.lv=OtusRoot/LogVol00 rd.lvm.lv=OtusRoot/LogVol01 rhgb quie$
GRUB_DISABLE_RECOVERY="true"
```
>- Pаздел, начинающийся с linux16 /vmlinuz - это строка, которая сообщает GRUB, как запустить ядро.
```
……
linux16 /vmlinuz-3.10.0-862.2.3.el7.x86_64 root=/dev/mapper/OtusRoot-LogVol00 ro no_timer_check console=tty0 console=ttyS0,115200n8 net.ifnames=0 biosdevname=0 elevator=noop crashkernel=auto rd.lvm.lv=OtusRoot/LogVol00 rd.lvm.lv=OtusRoot/LogVol01 rhgb quiet 
……
```
- Пересоздать **initrd image**, чтобы он знал новое название **Volume Group**.
```
[root@lvm ~]# mkinitrd -f -v /boot/initramfs-$(uname -r).img $(uname -r)
Executing: /sbin/dracut -f -v /boot/initramfs-3.10.0-862.2.3.el7.x86_64.img 3.10.0-862.2.3.el7.x86_64
dracut module 'busybox' will not be installed, because command 'busybox' could not be found!
dracut module 'crypt' will not be installed, because command 'cryptsetup' could not be found!
dracut module 'dmraid' will not be installed, because command 'dmraid' could not be found!
dracut module 'dmsquash-live-ntfs' will not be installed, because command 'ntfs-3g' could not be found!


......
*** Stripping files done ***
*** Generating early-microcode cpio image contents ***
*** Constructing AuthenticAMD.bin ****
*** No early-microcode cpio image needed ***
*** Store current command line parameters ***
*** Creating image file ***
*** Creating image file done ***
*** Creating initramfs image file '/boot/initramfs-3.10.0-862.2.3.el7.x86_64.img' done ***
```
- После чего можем перезагрузиться и проверить:
```
[vagrant@lvm ~]$ lsblk
NAME                  MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
sda                     8:0    0   40G  0 disk 
├─sda1                  8:1    0    1M  0 part 
├─sda2                  8:2    0    1G  0 part /boot
└─sda3                  8:3    0   39G  0 part 
  ├─OtusRoot-LogVol00 253:0    0 37.5G  0 lvm  /
  └─OtusRoot-LogVol01 253:1    0  1.5G  0 lvm  [SWAP]
```
```
[root@lvm ~]# vgs
  VG       #PV #LV #SN Attr   VSize   VFree
  OtusRoot   1   2   0 wz--n- <38.97g    0 
```
>- При желании можно так же заменить название **Logical Volume**

### Добавить модуль в initrd.

>- Скрипты модулей хранятся в каталоге **/usr/lib/dracut/modules.d/**. 

- Создатьпапку с именем **01test** в этом каталоге.
```
[root@lvm ~]# cd /usr/lib/dracut/modules.d/
[root@lvm modules.d]# mkdir /usr/lib/dracut/modules.d/01test
```
- В нее поместить скрипты:

1. [module-setup.sh](https://github.com/ellopa/otus-grub/blob/main/module-setup.sh) - который устанавливает модуль и вызывает скрипт test.sh
2. [test.sh](https://github.com/ellopa/otus-grub/blob/main/test.sh) - собственно сам вызывает скрипт, в нём у нас рисуется пингвинчик

- Пересобирать образ **initrd**

```bash
mkinitrd -f -v /boot/initramfs-$(uname -r).img $(uname -r)
```
  или

```bash
dracut -f -v
```
```
[root@lvm 01test]# dracut -f -v
Executing: /sbin/dracut -f -v
dracut module 'busybox' will not be installed, because command 'busybox' could not be found!
dracut module 'crypt' will not be installed, because command 'cryptsetup' could not be found!
dracut module 'dmraid' will not be installed, because command 'dmraid' could not be found!
dracut module 'dmsquash-live-ntfs' will not be installed, because command 'ntfs-3g' could not be found!
dracut module 'multipath' will not be installed, because command 'multipath' could not be found!
dracut module 'busybox' will not be installed, because command 'busybox' could not be found!
dracut module 'crypt' will not be installed, because command 'cryptsetup' could not be found!
dracut module 'dmraid' will not be installed, because command 'dmraid' could not be found!
dracut module 'dmsquash-live-ntfs' will not be installed, because command 'ntfs-3g' could not be found!
dracut module 'multipath' will not be installed, because command 'multipath' could not be found!
*** Including module: bash ***
*** Including module: test ***
*** Including module: nss-softokn ***
*** Including module: i18n ***
*** Including module: drm ***
*** Including module: plymouth ***
*** Including module: dm ***
Skipping udev rule: 64-device-mapper.rules
Skipping udev rule: 60-persistent-storage-dm.rules
Skipping udev rule: 55-dm.rules
*** Including module: kernel-modules ***
Omitting driver floppy
*** Including module: lvm ***
Skipping udev rule: 64-device-mapper.rules
Skipping udev rule: 56-lvm.rules
Skipping udev rule: 60-persistent-storage-lvm.rules
*** Including module: qemu ***
*** Including module: resume ***
*** Including module: rootfs-block ***
*** Including module: terminfo ***
*** Including module: udev-rules ***
Skipping udev rule: 40-redhat-cpu-hotplug.rules
Skipping udev rule: 91-permissions.rules
*** Including module: biosdevname ***
*** Including module: systemd ***
*** Including module: usrmount ***
*** Including module: base ***
*** Including module: fs-lib ***
*** Including module: shutdown ***
*** Including modules done ***
*** Installing kernel module dependencies and firmware ***
*** Installing kernel module dependencies and firmware done ***
*** Resolving executable dependencies ***
*** Resolving executable dependencies done***
*** Hardlinking files ***
*** Hardlinking files done ***
*** Stripping files ***
*** Stripping files done ***
*** Generating early-microcode cpio image contents ***
*** Constructing AuthenticAMD.bin ****
*** No early-microcode cpio image needed ***
*** Store current command line parameters ***
*** Creating image file ***
*** Creating image file done ***
*** Creating initramfs image file '/boot/initramfs-3.10.0-862.2.3.el7.x86_64.img' done ***
```
- Можно проверить/посмотреть какие модули загружены в образ:
```
[root@lvm 01test]# lsinitrd -m /boot/initramfs-$(uname -r).img | grep test
test
```
- После чего можно пойти двумя путями для проверки:
	- Перезагрузиться и выключить опции **rghb** и **quiet**
	- Либо отредактировать **grub.cfg** убрав эти опции
- В итоге при загрузке будет пауза на 10 секунд и мы увидим пингвина в выводе терминала

![screenshot1](https://github.com/ellopa/otus-grub/blob/main/screenshot4.png)

